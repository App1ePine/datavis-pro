# DataVis Pro - 开发进度跟踪文档

> **项目名称**：DataVis Pro `/ˈdeɪtə vɪz proʊ/`
>
> 本文档用于跟踪项目开发进度，方便 AI 助手理解项目当前状态并协助制定和执行开发计划。

**最后更新**：2026-01-26
**当前版本**：v0.1.0
**维护者**：ApplePine
**项目状态**：核心功能已完成，数据转换功能已实现，可视化基础功能已完成

---

## 📊 项目概览

### 项目定位

DataVis Pro 是一款基于 Tauri + Vue 3 + Rust + Polars 构建的高性能数据分析桌面应用，专注于提供快速、流畅的数据导入、清洗、转换和可视化体验。

### 核心架构

- **前端**：Vue 3 + TypeScript + Element Plus + ag-Grid
- **后端**：Rust + Tauri 2.0 + Polars (SQL 支持)
- **数据存储**：基于历史栈的内存存储（支持 Undo/Redo）
- **通信机制**：IPC (进程间通信)

### 技术亮点

1. **历史栈架构**：每次操作存储完整状态，支持无限次 Undo/Redo
2. **SQL 筛选**：使用 Polars SQL 功能，支持标准 SQL WHERE 语法
3. **高性能**：Polars 数据处理速度比 Pandas 快 5-10 倍
4. **轻量级**：打包后约 5-10 MB，比 Electron 小 10 倍

---

## ✅ 已完成功能（Phase 1 & 2）

### 1. 文件导入/导出 ✅

#### 导入功能

- [x] CSV 文件导入（UTF-8 编码）
- [x] TSV 文件导入（制表符分隔）
- [x] Excel 文件导入（.xlsx 和 .xls）
- [x] Parquet 文件导入
- [x] 文件类型过滤器（5 种：全部、CSV、TSV、Excel、Parquet）
- [x] 自动检测 Excel 工作表
- [x] 导入后自动加载数据到表格

**实现文件**：

- `src-tauri/src/commands/file_import.rs`
- `src-tauri/src/data/loader.rs`
- `src/App.vue` (handleImportData)

#### 导出功能

- [x] CSV 格式导出
- [x] Parquet 格式导出
- [x] 导出对话框（卡片式格式选择）
- [x] 格式说明和提示

**实现文件**：

- `src-tauri/src/commands/data_export.rs`
- `src/components/dialogs/ExportDialog.vue`
- `src/App.vue` (handleExportData, handleExportConfirm)

### 2. 历史管理系统 ✅

- [x] 历史栈数据结构（Vec<HistoryEntry>）
- [x] 当前索引跟踪（current_index）
- [x] 线性历史（回退后新操作丢弃后续历史）
- [x] 最大历史深度限制（默认 50 条）
- [x] Undo 功能（撤销操作）
- [x] Redo 功能（重做操作）
- [x] 跳转到指定历史节点
- [x] 重置到初始状态
- [x] 清空所有数据和历史
- [x] 快捷键支持（Ctrl+Z / Cmd+Z, Ctrl+Shift+Z / Cmd+Shift+Z）

**实现文件**：

- `src-tauri/src/data/store.rs` (DataStore 核心)
- `src-tauri/src/commands/history.rs` (历史管理命令)
- `src-tauri/src/models/history.rs` (HistoryEntry, OperationType)
- `src/stores/dataStore.ts` (前端历史管理)
- `src/App.vue` (快捷键处理)

### 3. 数据操作功能 ✅

#### 列操作

- [x] **选择列**：保留选中的列，删除其他列
- [x] **删除列**：删除选中的列
- [x] **重命名列**：批量修改列名
- [x] **类型转换**：转换列的数据类型（Int64, Float64, String, Boolean, Date, Datetime）

**实现文件**：

- `src-tauri/src/commands/operations.rs` (select_columns, drop_columns, rename_columns, cast_types)
- `src/components/dialogs/SelectColumnsDialog.vue`
- `src/components/dialogs/RenameColumnsDialog.vue`
- `src/components/dialogs/CastTypesDialog.vue`

#### 行操作

- [x] **删除空值行**：删除包含空值的行（可选择特定列）
- [x] **删除全空行**：删除所有列都为空的行
- [x] **SQL 筛选**：使用 SQL WHERE 语法筛选数据
    - 支持操作符：`>`, `<`, `>=`, `<=`, `=`, `!=`, `AND`, `OR`, `IS NULL`, `IS NOT NULL`, `LIKE`, `IN`
    - 自动处理列名中的特殊字符（空格、点号等）

**实现文件**：

- `src-tauri/src/commands/operations.rs` (drop_nulls, drop_all_nulls, filter_data)
- `src/components/dialogs/FilterDialog.vue`

#### 排序

- [x] **排序**：按单列升序/降序排序，支持空值置后

**实现文件**：

- `src-tauri/src/commands/operations.rs` (sort_data)
- `src/components/dialogs/SortDialog.vue`

#### 空值填充

- [x] **向前填充 (Forward)**：使用前一个非空值
- [x] **向后填充 (Backward)**：使用后一个非空值
- [x] **最小值填充 (Min)**：使用列的最小值
- [x] **最大值填充 (Max)**：使用列的最大值
- [x] **均值填充 (Mean)**：使用列的平均值
- [x] **零值填充 (Zero)**：使用 0
- [x] **1 值填充 (One)**：使用 1
- [x] 列选择（必须选择至少一列）

**实现文件**：

- `src-tauri/src/commands/operations.rs` (fill_null)
- `src/components/dialogs/FillNullDialog.vue`

#### 数据转换（Phase 2.5 新增）✅

- [x] **Unpivot（宽表转长表）**：将宽格式数据转为长格式
    - 支持自定义索引列和值列
    - 支持自定义变量列名和值列名
    - 支持结果排序
- [x] **Pivot（长表转宽表）**：将长格式数据转为宽格式（透视表）
    - 支持多索引列
    - 支持 8 种聚合函数（first, last, sum, mean, min, max, count, median）
    - 使用 polars-ops 的 pivot_stable 实现
- [x] **滑动窗口计算**：时间序列分析
    - 移动平均（Rolling Average）
    - 移动中位数（Rolling Median）
    - 移动求和（Rolling Sum）
    - 移动最小值（Rolling Min）
    - 移动最大值（Rolling Max）
    - 移动标准差（Rolling Std）
    - 移动方差（Rolling Var）
    - 移动分位数（Rolling Quantile）
    - 支持窗口居中、最小样本数配置

**实现文件**：

- `src-tauri/src/commands/operations.rs` (unpivot_data, pivot_data, rolling_*)
- `src/components/dialogs/UnpivotDialog.vue`
- `src/components/dialogs/PivotDialog.vue`
- `src/components/dialogs/RollingDialog.vue`
- `src-tauri/Cargo.toml` (新增 polars-ops 依赖)

**技术亮点**：

- 使用 `tauri::async_runtime::spawn_blocking` 避免阻塞主线程
- Pivot 使用预聚合 + pivot_stable 两步法，避免类型问题
- Rolling 操作支持丰富的配置选项（center, min_periods）
- 所有操作集成到历史栈，支持 Undo/Redo

### 4. 数据展示 ✅

- [x] ag-Grid 高性能表格
- [x] 虚拟滚动（支持百万行数据）
- [x] 无限滚动加载（分页加载）
- [x] 列排序
- [x] 列筛选
- [x] 列宽调整
- [x] 数据信息栏（行数、列数、文件名）
- [x] 列统计信息（右侧面板）

**实现文件**：

- `src/components/DataGrid.vue`
- `src/components/DataInfoBar.vue`
- `src/components/RightSidebar.vue`

### 5. 用户界面 ✅

- [x] 主应用布局（Header + Sidebar + Content + RightSidebar）
- [x] 左侧操作面板（Sidebar）
- [x] 右侧统计面板（RightSidebar）
- [x] 顶部工具栏（导入、导出、重置、清空）
- [x] 所有对话框组件
- [x] 加载状态和错误提示
- [x] 响应式设计

**实现文件**：

- `src/App.vue`
- `src/components/Sidebar.vue`
- `src/components/RightSidebar.vue`
- `src/components/dialogs/*.vue`

---

## 🚧 待开发功能（Phase 3+）

### 高优先级

#### 1. 数据可视化 🎯

- [x] 图表类型选择（折线图、柱状图、散点图、饼图、直方图）
- [x] 基于 ECharts 的图表渲染（dataset 模式）
- [x] 图表配置面板（X 轴、Y 轴、系列选择）
- [x] 折线图支持双 Y 轴
- [x] 折线图支持面积/堆积面积样式
- [ ] 图表导出（PNG、SVG）
- [ ] 多图表管理

**技术方案**：

- 前端：Vue-ECharts 组件（dataset + encode）
- 后端：Polars 生成 dataset
- 新增命令：`generate_chart_data`

#### 2. 数据透视表 ✅

- [x] 透视表配置界面
- [x] 行字段、列字段、值字段选择
- [x] 聚合函数选择（求和、平均、计数、最大、最小、first、last、median）
- [x] 透视表结果展示
- [x] 反透视（Unpivot）功能
- [x] 滑动窗口计算（8 种统计函数）

**实现状态**：✅ 已完成

**实现文件**：

- `src-tauri/src/commands/operations.rs` (pivot_data, unpivot_data, rolling_*)
- `src/components/dialogs/PivotDialog.vue`
- `src/components/dialogs/UnpivotDialog.vue`
- `src/components/dialogs/RollingDialog.vue`
- `src-tauri/Cargo.toml` (polars-ops 依赖)

**技术方案**：

- 使用 Polars `pivot_stable` 和 `unpivot` 功能
- 命令：`pivot_data`, `unpivot_data`, `rolling_average`, `rolling_median`, `rolling_sum`, `rolling_min`, `rolling_max`,
  `rolling_std`, `rolling_var`, `rolling_quantile`
- 使用 `spawn_blocking` 避免阻塞主线程
- 集成到历史栈，支持 Undo/Redo

#### 3. 高级筛选 🎯

- [ ] 可视化筛选构建器（无需写 SQL）
- [ ] 多条件组合（AND/OR）
- [ ] 条件模板保存和加载
- [ ] 筛选历史记录

**技术方案**：

- 前端：条件构建器组件
- 后端：将条件转换为 SQL WHERE 语句

### 中优先级

#### 4. 数据统计分析 📊

- [ ] 描述性统计（均值、中位数、标准差、四分位数）
- [ ] 相关性分析
- [ ] 分组统计
- [ ] 统计结果导出

**技术方案**：

- 使用 Polars 统计函数
- 新增命令：`describe_data`, `correlation_matrix`, `group_by_stats`

#### 5. 数据合并和连接 🔗

- [ ] 多数据集管理（恢复多数据集支持）
- [ ] 数据集连接（Inner Join, Left Join, Right Join, Outer Join）
- [ ] 数据集合并（Concat, Append）
- [ ] 连接键选择和预览

**技术方案**：

- 修改 DataStore 支持多数据集
- 使用 Polars `join` 和 `concat` 功能
- 新增命令：`join_datasets`, `concat_datasets`

#### 6. 数据导出增强 📤

- [ ] 导出选项配置（分隔符、编码、压缩）
- [ ] 导出预览
- [ ] 批量导出
- [ ] 导出到数据库（SQLite, PostgreSQL）

### 低优先级

#### 7. 持久化存储 💾

- [ ] 项目文件格式（.dvp）
- [ ] 保存当前状态（数据 + 历史）
- [ ] 加载项目文件
- [ ] 自动保存和恢复

**技术方案**：

- 使用 Parquet 存储数据
- 使用 JSON 存储元信息和历史
- 新增命令：`save_project`, `load_project`

#### 8. 数据验证和清洗 🧹

- [ ] 数据类型验证
- [ ] 重复值检测和删除
- [ ] 异常值检测
- [ ] 数据标准化和归一化

#### 9. 插件系统 🔌

- [ ] 插件 API 定义
- [ ] 插件加载和管理
- [ ] 自定义数据操作插件
- [ ] 自定义图表插件

---

## 🐛 已知问题和技术债务

### 已知问题

1. **大数据集内存占用**
    - 问题：历史栈存储完整 DataFrame，大数据集占用内存较高
    - 影响：100MB 数据集 × 50 条历史 = 5GB 内存
    - 优先级：中
    - 解决方案：
        - 短期：降低默认历史深度（50 → 20）
        - 长期：实现增量存储（只存储操作，不存储完整数据）

2. **Excel 大文件导入速度**
    - 问题：大型 Excel 文件（>50MB）导入较慢
    - 原因：Calamine 解析速度限制
    - 优先级：低
    - 解决方案：添加进度条和取消功能

### 技术债务

1. **错误处理不统一**
    - 问题：部分错误直接返回字符串，部分使用自定义错误类型
    - 影响：错误信息不一致，难以调试
    - 优先级：中
    - 解决方案：统一使用 `DataAnalystError` 类型

2. **前端类型定义不完整**
    - 问题：部分 Tauri 命令返回类型使用 `any`
    - 影响：类型安全性降低
    - 优先级：低
    - 解决方案：补充完整的 TypeScript 类型定义

3. **测试覆盖率低**
    - 问题：缺少单元测试和集成测试
    - 影响：重构风险高，难以保证代码质量
    - 优先级：高
    - 解决方案：
        - Rust：使用 `cargo test` 添加单元测试
        - Vue：使用 Vitest 添加组件测试

4. **代码注释不足**
    - 问题：部分复杂逻辑缺少注释
    - 影响：代码可维护性降低
    - 优先级：低
    - 解决方案：逐步补充注释和文档

---

## 🎯 下一步计划

1. **完善测试**
    - 添加 Rust 单元测试（数据操作、历史管理）
    - 添加 Vue 组件测试（对话框、表格）
    - 目标：测试覆盖率 > 60%

2. **性能优化**
    - 优化大数据集加载速度
    - 降低内存占用（调整历史深度）
    - 添加性能监控和日志

3. **用户体验优化**
    - 添加操作进度条
    - 优化错误提示信息
    - 添加操作确认对话框（删除列、清空数据等）


1. **数据可视化**
    - 实现基础图表功能
    - 支持 4-5 种常用图表类型
    - 图表配置和导出

2. **数据透视表**
    - 实现透视表功能
    - 支持多维度分析

3. **高级筛选**
    - 可视化筛选构建器
    - 筛选模板管理

### 长期目标（3-6 个月）

1. **数据分析增强**
    - 统计分析功能
    - 数据合并和连接
    - 数据验证和清洗

2. **持久化存储**
    - 项目文件格式
    - 自动保存和恢复

3. **插件系统**
    - 插件 API 设计
    - 插件市场

---

## 📝 开发规范

### 代码提交规范

使用语义化提交信息：

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `refactor`: 代码重构
- `test`: 测试相关
- `chore`: 构建/工具相关

示例：

```
feat: 添加数据透视表功能
fix: 修复 SQL 筛选中特殊字符处理问题
docs: 更新 README 和架构说明文档
refactor: 重构历史栈数据结构
test: 添加数据操作单元测试
```

### 分支管理

- `main`: 主分支，稳定版本
- `develop`: 开发分支，最新功能
- `feature/*`: 功能分支
- `fix/*`: 修复分支

### 代码审查

- 所有代码必须经过审查才能合并到 `main`
- 审查重点：代码质量、测试覆盖、文档完整性

---

## 🤖 AI 协作指南

### 如何使用本文档

1. **理解项目状态**：查看"已完成功能"和"待开发功能"章节
2. **选择任务**：从"待开发功能"中选择合适的任务
3. **制定计划**：参考"预计工作量"和"技术方案"
4. **执行开发**：按照"开发规范"进行开发
5. **更新文档**：完成后更新本文档的进度

### 常见任务模板

#### 添加新的数据操作

1. 在 `src-tauri/src/models/history.rs` 中定义操作类型
2. 在 `src-tauri/src/commands/operations.rs` 中实现命令
3. 在 `src-tauri/src/lib.rs` 中注册命令
4. 在 `src/utils/tauri-commands.ts` 中封装调用
5. 在 `src/stores/dataStore.ts` 中添加方法
6. 创建对话框组件（如需要）
7. 在 Sidebar 中添加按钮（如需要）

#### 添加新的图表类型

1. 在 `src/components/charts/` 中创建图表组件
2. 在 `src-tauri/src/commands/` 中添加数据聚合命令
3. 在图表配置面板中添加选项
4. 测试和优化性能

### 关键文件清单

**Rust 后端**：

- `src-tauri/src/lib.rs` - 命令注册
- `src-tauri/src/data/store.rs` - 数据存储核心
- `src-tauri/src/commands/operations.rs` - 数据操作
- `src-tauri/src/models/history.rs` - 历史类型定义

**Vue 前端**：

- `src/App.vue` - 主应用组件
- `src/stores/dataStore.ts` - 状态管理
- `src/components/Sidebar.vue` - 操作面板
- `src/utils/tauri-commands.ts` - 命令封装

---

## 📊 项目统计

### 功能完成度

- **Phase 1（Rust 后端）**：100% ✅
- **Phase 2（前端基础）**：100% ✅
- **Phase 2.5（数据转换）**：100% ✅
- **Phase 3（数据可视化）**：70% 🚧
- **Phase 4（高级功能）**：0% 🚧

### 代码统计

- **Rust 命令数量**：25+ 个 Tauri 命令
- **Vue 组件数量**：15+ 个组件
- **对话框组件**：14 个（ColumnSelection, Rename, CastTypes, Filter, FillNull, Sort, Pivot, Unpivot, Rolling, LineChart,
  BarChart, ScatterChart, PieChart, Histogram）
- **数据操作类型**：18 种（OperationType 枚举）

### 最新完成（2026-01-26）

**Phase 2.5 - 数据转换功能** ✅

1. **Unpivot（宽表转长表）**
    - 实现文件：`operations.rs:521-598`
    - 前端组件：`UnpivotDialog.vue`
    - 支持索引列、值列、自定义列名、结果排序

2. **Pivot（长表转宽表）**
    - 实现文件：`operations.rs:603-687`
    - 前端组件：`PivotDialog.vue`
    - 使用 `polars-ops::pivot_stable` 实现
    - 支持 8 种聚合函数

3. **滑动窗口计算（8 种）**
    - 实现文件：`operations.rs:692-1130`
    - 前端组件：`RollingDialog.vue`
    - 包括：average, median, sum, min, max, std, var, quantile
    - 支持窗口居中、最小样本数配置

**技术改进**：

- 所有操作使用 `spawn_blocking` 避免阻塞
- 新增 `polars-ops` 依赖解决 pivot 类型问题
- 历史栈支持新增的操作类型
- 前端对话框支持丰富的配置选项

**Phase 3 - 可视化基础功能** ✅

1. **图表渲染（dataset 模式）**
    - 覆盖折线/柱状/散点/饼图/直方图
    - 前端：Vue-ECharts + encode
    - 后端：Polars 生成 dataset

2. **折线图增强**
    - 支持双 Y 轴（右侧系列选择）
    - 支持面积/堆积面积样式

3. **直方图**
    - 支持数值列分箱配置
    - 可视化入口与配置对话框

**Phase 2 - 数据操作补充** ✅

1. **排序**
    - 单列升序/降序
    - 空值置后开关

---
